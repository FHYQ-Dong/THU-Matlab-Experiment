\documentclass[utf8]{article}

\input{chants.tex}


\title{MATLAB音乐合成实验报告}
\author{FHYQ-Dong} 
\date{\zhtoday}

\begin{document}

\maketitle
\thispagestyle{fancy}

\section{简单的合成音乐}
\begin{enumerate}
    \item \label{ex:1}\textbf{要求：}请根据《东方红》片断的简谱和``十二平均律''计算出该片断中各个乐音的频率，在MATLAB中生成幅度为1、抽样频率为8kHz的正弦信号表示这些乐音。请用sound函数播放每个乐音，听一听音调是否正确。最后用这一系列乐音信号拼出《东方红》片断，注意控制每个乐音持续的时间要符合节拍，用sound播放你合成的音乐，听起来感觉如何？ \\
        \textbf{实现：}事先根据十二平均律计算出各个音符的频率，存储至文件attachments/note2freq.mat中以备使用。通过产生简单的正弦信号即可实现音乐合成。代码见Listing \ref{code:ex-1}. \\
        \textbf{结果：}见文件attachments/ex\_1.wav.
    \item \label{ex:2}\textbf{要求：}你一定注意到实验 \ref{ex:1} 的乐曲中相邻乐音之间有``啪''的杂声，这是由于相位不连续产生了高频分量。这种噪声严重影响合成音乐的质量，丧失真实感。为了消除它，我们可以用包络修正每个乐音，以保证在乐音的邻接处信号幅度为零。此外建议用指数衰减的包络来表示。 \\
        \textbf{实现：}在实验 \ref{ex:1} 的基础上，增加了包络函数的实现。包络函数图像如图 \ref{fig:ex-2}，代码见Listing \ref{code:ex-2}. \\
        \textbf{结果：}见文件attachments/ex\_2.wav.
        \begin{figure}[H]
            \centering
            \includegraphics[width=0.8\textwidth]{images/ex_2.png}
            \caption{实验 \ref{ex:2} 的包络函数}
            \label{fig:ex-2}
        \end{figure}
    \item \label{ex:3}\textbf{要求：}请用最简单的方法将实验 \ref{ex:2} 中的音乐分别升高和降低一个八度。（提示：音乐播放的时间可以变化）再难一些，请用resample函数（也可以用interp和decimate函数）将上述音乐升高半个音阶。（提示：视计算复杂度，不必特别精确） \\
        \textbf{实现：}在实验 \ref{ex:2} 的基础上，直接隔点抽取达到升高八度的效果；使用repelem函数实现降低八度的效果；使用resample函数实现升高半个音阶的效果。代码见Listing \ref{code:ex-3}. \\
        \textbf{结果：}见文件attachments/ex\_3\_u8.wav, attachments/ex\_3\_d8.wav, attachments/ex\_3\_u05.wav.
    \item \label{ex:4}\textbf{要求：}试着在实验 \ref{ex:2} 的音乐中增加一些谐波分量，听一听音乐是否更有```厚度''了？注意谐波分量的能量要小，否则掩盖住基音反而听不清音调了。（如果选择基波幅度为1，二次谐波幅度0.2，三次谐波幅度0.3，听起来像不像象风琴？） \\
        \textbf{实现：}在实验 \ref{ex:2} 的基础上，通过生成多个正弦信号并叠加的方式实现谐波分量的添加。实验中取一次、二次、三次谐波分量的幅度分别为1、0.2、0.3。代码见Listing \ref{code:ex-4}. \\
        \textbf{结果：}见文件attachments/ex\_4.wav.
    \item \label{ex:5}\textbf{要求：}自选其它音乐合成，例如贝多芬第五交响乐的开头两小节。 \\
        \textbf{实现：}合成了贝多芬第五交响乐的开头两小节。特别地，实现了和弦的合成。代码见Listing \ref{code:ex-5}. \\
        \textbf{结果：}见文件attachments/ex\_5.wav.
\end{enumerate}


\section{用傅里叶级数分析音乐}
\begin{enumerate}
    \setcounter{enumi}{5}
    \item \label{ex:6}\textbf{要求：}先用wavread函数载入attachment/fmt.wav文件，播放出来听听效果如何？是否比刚才的合成音乐真实多了？ \\
        \textbf{实现：}使用wavread函数载入音频文件，并使用sound函数播放。代码见Listing \ref{code:ex-6}. \\
        \textbf{结果：}确实真实多了。
    \item \label{ex:7}\textbf{要求：}你知道待处理的wave2proc是如何从真实值realwave中得到的么？这个预处理过程可以去除真实乐曲中的非线性谐波和噪声，对于正确分析音调是非常重要的。提示：从时域做，可以继续使用resample函数。 \\
        \textbf{实现：}我猜想可以通过去除信号的直流分量来滤除噪声；通过一个带通滤波器来滤除非线性谐波，但不是非常确定，实现的结果看上去也不是非常像。代码见Listing \ref{code:ex-7}. \\
        \textbf{结果：}见图 \ref{fig:ex-7}，我处理后的信号与wave2proc相比，整体上有缓慢起伏。怀疑是带通滤波器的影响。
        \begin{figure}[H]
            \centering
            \includegraphics[width=0.5\textwidth]{images/ex_7.png}
            \vspace{-2em}
            \caption{实验 \ref{ex:7} 的处理结果}
            \label{fig:ex-7}
        \end{figure}
    \item \label{ex:8}\textbf{要求：}这段音乐的基频是多少？是哪个音调？请用傅里叶级数或者变换的方法分析它的谐波分量分别是什么。提示：简单的方法是近似取出一个周期求傅里叶级数但这样明显不准确，因为你应该已经发现基音周期不是整数（这里不允许使用resample函数）。复杂些的方法是对整个信号求傅里叶变换（回忆周期性信号的傅里叶变换），但你可能发现无论你如何提高频域的分辨率，也得不到精确的包络（应该近似于冲激函数而不是 sinc 函数），可选的方法是增加时域的数据量，即再把时域信号重复若干次，看看这样是否效果好多了？请解释之。 \\
        \textbf{实现：}将原始信号重复10次后做FFT。这样效果变好的原因是：有限长信号可以看作是无限长信号乘上一个矩形窗。FFT后相当于无限长信号的频谱卷上sinc函数。在时域将信号重复多次相当于拉宽的矩形窗的宽度，从而频域sinc函数变窄，分辨率提高。代码见Listing \ref{code:ex-8}. \\
        \textbf{结果：}频谱图见图 \ref{fig:ex-8}，基频：222.0459 Hz，音调：A3.
        \begin{figure}[H]
            \centering
            \includegraphics[width=0.5\textwidth]{images/ex_8.png}
            \caption{实验 \ref{ex:8} 的频谱图}
            \label{fig:ex-8}
        \end{figure}
    \item \label{ex:9}\textbf{要求：}再次载入attachments/fmt.wav，现在要求你写一段程序，自动分析出这段乐曲的音调和节拍！ \\
        \textbf{实现：}使用FFT分析音调：取频谱的最大值对应的频率作为基音音调；使用自相关函数分析节拍：先求音频信号的能量（平方），再进行自相关。排除0延迟附近的值，找到自相关函数的第一个峰值对应的延迟作为节拍。代码见Listing \ref{code:ex-9}. \\
        \textbf{体会：}一开始分析节拍的时候并没有求信号的能量。这样求出来的BPM十分小（大约三十几）。在后续通过吉他频谱合成东方红音乐时发现三十几的BPM造成一拍内的音符数量过多，无法准确分析基音。 \\
        \textbf{结果：}音调：A3，222.05 Hz；节拍周期：0.50 秒，119.94 BPM.
\end{enumerate}


\section{基于傅里叶级数的合成音乐}
\begin{enumerate}
    \setcounter{enumi}{9}
    \item \label{ex:10}\textbf{要求：}用实验 \ref{ex:7} 计算出来的傅里叶级数再次完成实验 \ref{ex:4}，听一听是否像演奏fmt.wav的吉他演奏出来的？ \\
        \textbf{实现：}与实验 \ref{ex:11} 一起完成。
    \item \label{ex:11}\textbf{要求：}也许实验 \ref{ex:9} 还不是很像，因为对于一把泛音丰富的吉他而言，不可能每个音调对应的泛音数量和幅度都相同。但是通过完成实验 \ref{ex:8}，你已经提取出fmt.wav中的很多音调，或者说，掌握了每个音调对应的傅里叶级数，大致了解了这把吉他的特征。现在就来演奏一曲《东方红》吧。提示：如果还是音调信息不够，那就利用相邻音调的信息近似好了，毕竟可以假设吉他的频响是连续变化的。 \\
        \textbf{实现：}合成流程如下：
        \begin{enumerate}
            \item 载入音频文件
            \item 分析音频的节拍信息
            \item 对每一拍，分析其基波和各次谐波
            \item 通过将《东方红》的音符临近匹配到存在数据的基音上，合成每个音符
            \item 将各个音符施加包络，合并成完整的旋律
        \end{enumerate}
        我一开始使用实验 \ref{ex:8} 的方法获取每拍内的基音，但是写到一半（listing \ref{code:music-synthesis-old}）检查发现如此分析的结果是各个节拍内的基音频率都是一个值。后来询问ChatGPT\footnote{相关交流记录见此链接：\href{https://chatgpt.com/share/688b87a3-ab10-800e-a8f9-f033995d00f4}{https://chatgpt.com/share/688b87a3-ab10-800e-a8f9-f033995d00f4}}得知更加稳定的分析频谱的方式是：
        \begin{enumerate}
            \item 对每一拍内的原始音频信号进行预处理，包括去除直流分量、加窗等
            \item 通过自相关函数而非直接FFT分析基音频率
            \item 对每一拍内的音频信号进行时间整形：取整数个周期（采样率除以基音频率为一个周期内的采样点数）的音频信号做多周期平均、归一化等，得到单周期内的音频信号
            \item 对单周期内的音频信号做FFT，获取各次谐波的傅里叶级数
        \end{enumerate}
        其中，使用自相关函数而非FFT分析基音频率的原因有以下几点：
        \begin{enumerate}
            \item FFT若想达到较高的频域精度，时域的窗需要足够长。这样会跨越多个音符导致识别不准
            \item 谱峰往往出现在谐波，基波峰可能被掩盖
            \item 直接FFT可能出现一拍内有非整数个周期，造成频谱泄露混叠
        \end{enumerate}
        经过ChatGPT提示，最终完整的代码见Listing \ref{code:music-synthesis}. \\
        \textbf{结果：}合成的音乐见文件attachmentss/dongfanghong\_synth.wav
\end{enumerate}

\newpage
\appendix
\input{appA_Sources.tex}

\end{document}
